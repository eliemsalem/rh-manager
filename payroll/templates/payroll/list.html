{% extends "employees/base.html" %}
{% block title %}Payroll ¬∑ HR Manager{% endblock %}

{% block content %}
<div class="col" style="flex: 0 0 100%; max-width: 100%;">
  <div class="card shadow-sm border-0 p-3">

    <!-- Header & actions -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <h5 class="mb-0"><i class="bi bi-cash-stack"></i> Payroll Overview</h5>
      <div class="d-flex gap-2 flex-wrap">
        <a class="btn btn-success" href="{% url 'payroll:payroll_generate' %}?year={{ year }}&month={{ month }}">
          <i class="bi bi-gear"></i> Generate for Active Employees
        </a>
        <a class="btn btn-outline-secondary" href="{% url 'payroll:payroll_bulk_zip' year month %}">
          <i class="bi bi-archive"></i> Download ZIP
        </a>
        <a class="btn btn-outline-success" href="{% url 'payroll:payroll_export_excel' %}?year={{ year }}&month={{ month }}">
          <i class="bi bi-file-earmark-excel"></i> Export Excel
        </a>
      </div>
    </div>

    <!-- Payroll Table -->
    <div class="table-responsive">
      <table id="payrollTable" class="table table-hover table-striped align-middle text-nowrap">
        <thead class="table-light">
          <tr>
            <th>Employee</th>
            <th>Country</th>
            <th>Project</th>
            <th>Contract Type</th>
            <th>Company</th>
            <th>Bank</th>
            <th>Base</th>
            <th>Overtime</th>
            <th>Reimbursement</th>
            <th>Others</th>
            <th>Deduction</th>
            <th>Total</th>
            <th>Last Day</th>
            <th>Comment</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>

        <tbody>
          {% for it in items %}
          <tr>
            <td>{{ it.employee.prenom }} {{ it.employee.nom }}</td>
            <td>{{ it.employee.country|default:"‚Äî" }}</td>
            <td>{{ it.employee.project|default:"‚Äî" }}</td>
            <td>{{ it.employee.contract_type|default:"‚Äî" }}</td>
            <td>{{ it.employee.contract_company|default:"‚Äî" }}</td>
            <td>{{ it.employee.bank_name|default:"‚Äî" }}</td>
            <td>{{ it.salaire_base|floatformat:2 }} {{ it.devise }}</td>
            <td>
              {% if it.heures_supp %}
                {{ it.heures_supp }}h ‚Üí {{ it.montant_heures_supp|floatformat:2 }} {{ it.devise }}
              {% else %}
                ‚Äì
              {% endif %}
            </td>
            <td>{{ it.remboursement|default:"‚Äî" }}</td>
            <td>{{ it.autres|default:"‚Äî" }}</td>
            <td>{{ it.deduction|default:"‚Äî" }}</td>
            <td><strong>{{ it.total_paye|floatformat:2 }} {{ it.devise }}</strong></td>
            <td>
              {% if it.employee.last_day %}
                <span class="text-danger fw-semibold">{{ it.employee.last_day|date:"d/m/Y" }}</span>
              {% else %}
                <span class="text-muted">‚Äî</span>
              {% endif %}
            </td>
            <td>{{ it.employee.comment|truncatechars:30 }}</td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-primary" href="{% url 'payroll:payroll_edit' it.pk %}">
                <i class="bi bi-pencil"></i>
              </a>
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'payroll:payroll_pdf' it.pk %}">
                <i class="bi bi-filetype-pdf"></i>
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="15" class="text-center text-muted py-3">No payroll found for this period.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ‚úÖ DataTables Dependencies -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<!-- ‚úÖ Initialize DataTable -->
<script>
  $(document).ready(function() {
    $('#payrollTable').DataTable({
      pageLength: 15,
      lengthChange: false,
      order: [[0, 'asc']],
      language: {
        search: "üîç Search:",
        info: "Showing _START_ to _END_ of _TOTAL_ payroll entries",
        infoEmpty: "No payroll entries",
        zeroRecords: "No matching results",
        paginate: {
          first: "¬´",
          last: "¬ª",
          next: "‚Ä∫",
          previous: "‚Äπ"
        }
      }
    });
  });
</script>

{% endblock %}
