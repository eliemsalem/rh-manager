{% extends "employees/base.html" %}
{% block title %}Payroll ¬∑ HR Manager{% endblock %}

{% block content %}
<div class="col" style="flex: 0 0 100%; max-width: 100%;">
  <div class="card shadow-sm border-0 p-3">

    <!-- Header & Filters -->
    <div class="d-flex flex-wrap justify-content-between align-items-end mb-4">
      <div>
        <h5 class="mb-2"><i class="bi bi-cash-stack"></i> Payroll Overview</h5>
        <form method="get" class="d-flex flex-wrap align-items-end gap-2">
          <div>
            <label class="form-label mb-0 fw-semibold">Month</label>
            <select name="month" class="form-select">
              {% for m, mname in months %}
                <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ mname|capfirst }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="form-label mb-0 fw-semibold">Year</label>
            <select name="year" class="form-select">
              {% for y in years %}
                <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
          </div>
          <button class="btn btn-primary mt-3">
            <i class="bi bi-funnel"></i> Filter
          </button>
        </form>
      </div>

      <!-- Actions -->
      <div class="d-flex gap-2 flex-wrap">
        <a class="btn btn-success" href="{% url 'payroll:payroll_generate' %}?year={{ year }}&month={{ month }}">
          <i class="bi bi-gear"></i> Generate for Active Employees
        </a>
        <a class="btn btn-outline-secondary" href="{% url 'payroll:payroll_bulk_zip' year month %}">
          <i class="bi bi-archive"></i> Download ZIP
        </a>
        <a class="btn btn-outline-success" href="{% url 'payroll:payroll_export_excel' %}?year={{ year }}&month={{ month }}">
          <i class="bi bi-file-earmark-excel"></i> Export Excel
        </a>
      </div>
    </div>

    <!-- Payroll Table -->
    <div class="table-responsive">
      <table id="payrollTable" class="table table-hover table-striped align-middle text-nowrap">
        <thead class="table-light">
          <tr>
            <th>Employee</th>
            <th>Country</th>
            <th>Project</th>
            <th>Contract Type</th>
            <th>Company</th>
            <th>Bank</th>
            <th>Base</th>
            <th>Overtime</th>
            <th>Reimbursement</th>
            <th>Others</th>
            <th>Deduction</th>
            <th>Total</th>
            <th>Last Day</th>
            <th>Comment</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>

        <tbody>
          {% for it in items %}
          <tr>
            <td>{{ it.employee.prenom|default_if_none:"" }} {{ it.employee.nom|default_if_none:"" }}</td>
            <td>{{ it.employee.country|default_if_none:"‚Äî" }}</td>
            <td>{{ it.employee.project|default_if_none:"‚Äî" }}</td>
            <td>{{ it.employee.contract_type|default_if_none:"‚Äî" }}</td>
            <td>{{ it.employee.contract_company|default_if_none:"‚Äî" }}</td>
            <td>{{ it.employee.bank_name|default_if_none:"‚Äî" }}</td>
            <td>{{ it.salaire_base|default_if_none:"‚Äî" }}</td>
            <td>
              {% if it.heures_supp %}
                {{ it.heures_supp }}h ‚Üí {{ it.montant_heures_supp|default_if_none:"‚Äî" }}
              {% else %}
                ‚Äî
              {% endif %}
            </td>
            <td>{{ it.remboursement|default_if_none:"‚Äî" }}</td>
            <td>{{ it.autres|default_if_none:"‚Äî" }}</td>
            <td>{{ it.deduction|default_if_none:"‚Äî" }}</td>
            <td><strong>{{ it.total_paye|default_if_none:"‚Äî" }}</strong></td>
            <td>
              {% if it.employee.last_day %}
                <span class="text-danger fw-semibold">{{ it.employee.last_day|date:"d/m/Y" }}</span>
              {% else %}
                <span class="text-muted">‚Äî</span>
              {% endif %}
            </td>
            <td>{{ it.employee.comment|default_if_none:"‚Äî"|truncatechars:30 }}</td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-primary" href="{% url 'payroll:payroll_edit' it.pk %}">
                <i class="bi bi-pencil"></i>
              </a>
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'payroll:payroll_pdf' it.pk %}">
                <i class="bi bi-filetype-pdf"></i>
              </a>
            </td>
          </tr>
          {% empty %}
          <!-- ‚úÖ Ligne vide compatible DataTables -->
          <tr>
            {% for i in "123456789012345" %}
              <td class="text-center text-muted">‚Äî</td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ‚úÖ DataTables Dependencies -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<!-- ‚úÖ Initialize DataTable -->
<script>
  $(document).ready(function() {
    const colCount = 15; // m√™me nombre que <th>

    $('#payrollTable').DataTable({
      pageLength: 50,
      lengthChange: true,
      autoWidth: false,
      responsive: true,
      order: [[0, 'asc']],
      columns: Array.from({ length: colCount }, () => ({ defaultContent: '‚Äî' })), // ‚úÖ corrige le warning
      language: {
        search: "üîç Search:",
        info: "Showing _START_ to _END_ of _TOTAL_ payroll entries",
        infoEmpty: "No payroll entries",
        zeroRecords: "No matching results",
        paginate: {
          first: "¬´",
          last: "¬ª",
          next: "‚Ä∫",
          previous: "‚Äπ"
        }
      }
    });
  });
</script>
{% endblock %}
